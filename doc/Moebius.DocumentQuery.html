    <!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Moebius.DocumentQuery – Moebius v1.0.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.10.0">
    <link rel="stylesheet" href="dist/app.css" />
    <script src="dist/sidebar_items.js"></script>
  </head>
  <body data-type="modules">

    <div class="main">
<button class="sidebar-toggle">
  <i class="icon-menu"></i>
</button>
<section class="sidebar">
  <button class="sidebar-toggle">
    <i class="icon-menu"></i>
  </button>

  
  <a href="Moebius.Query.html" class="sidebar-projectLink">
    <div class="sidebar-projectDetails">
      <h1 class="sidebar-projectName">
        Moebius
      </h1>
      <h2 class="sidebar-projectVersion">
        v1.0.0
      </h2>
    </div>
    
  </a>

  <div class="sidebar-search">
    <i class="icon-search"></i>
    <input type="text" class="sidebar-searchInput" placeholder="search" autocomplete="off" />
  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

    
      <li><a id="modules-list" href="#full-list">Modules</a></li>
    

    

    
  </ul>

  <ul id="full-list" class="sidebar-fullList"></ul>
  <div class="sidebar-noResults"></div>
</section>

<section class="content">
  <div id="content" class="content-inner">


      <h1>
        Moebius.DocumentQuery
        
        
          <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L1" title="View Source" class="view-source" rel="help">
            <i class="icon-code"></i>
          </a>
        
      </h1>

      
        <section id="moduledoc" class="docstring">
          <p>If you like your Postgres doing document goodness, then you’ll want to use this interface. Just include it in your module
and you can work directly with JSONB in PostgreSQL. We’ve tried to keep reasonable parity with
the Query interface, but there are some concepts here that are a bit different.</p>
<p>This entire module is predicated on a very particular structure for your document table. You don’t need to
create this table yourself, we’ll do it for you on <code class="inline">save/2</code> if it does not exist.</p>
<p>If you want to create it yourself, the SQL is:</p>
<pre><code class="sql">create table NAME(
  id serial primary key not null,
  body jsonb not null,
  search tsvector,
  created_at timestamptz not null default now(),
  updated_at timestamptz
);

-- index the search and jsonb fields
create index idx_NAME_search on NAME using GIN(search);
create index idx_NAME on NAME using GIN(body jsonb_path_ops);</code></pre>
<p>Using this structure we can apply some convention, making this interface particularly compelling. Of primary note is the Full Text search,
this ability (and speed) is what sets PostgreSQL above other document systems.</p>

        </section>
      

      
        <section id="summary" class="details-list">
          <h1 class="section-heading">
            <a class="hover-link" href="#summary">
              <i class="icon-link"></i>
            </a>
            Summary
          </h1>
          

          
  <div class="summary-functions summary">
    <h2>
      <a href="#functions">Functions</a>
    </h2>
    <div class="summary-row">
  <div class="summary-signature">
    <a href="#all/1">all(cmd)</a>
  </div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#contains/2">contains(cmd, criteria)</a>
  </div>
  
    <div class="summary-synopsis"><p>This is analagous to <code class="inline">filter</code> with the Query module, however this method is highly optimized for JSONB as it uses the <code class="inline">@</code> (contains)
operator. This flexes the GIN index created for your table (see above)</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#db/1">db(table)</a>
  </div>
  
    <div class="summary-synopsis"><p>Specifies the table or view you want to query and is an alias for the <a href="#db/1"><code class="inline">db/1</code></a> function using
a string as a table name. This is useful for specifying a table within a schema</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#delete/1">delete(cmd)</a>
  </div>
  
    <div class="summary-synopsis"><p>Deletes a document based on the filter (if any)</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#delete/2">delete(cmd, id)</a>
  </div>
  
    <div class="summary-synopsis"><p>Deletes a document with the given id</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#execute/2">execute(cmd, opts \\ nil)</a>
  </div>
  
    <div class="summary-synopsis"><p>Executes a query returning a list of items</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#exists/3">exists(cmd, field, params)</a>
  </div>
  
    <div class="summary-synopsis"><p>Queries a table using the existence operator. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to query embedded arrays this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#filter/3">filter(cmd, criteria, params \\ [])</a>
  </div>
  
    <div class="summary-synopsis"><p>Queries a table using matching string criteria. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to do a specialized query this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#filter/4">filter(cmd, field, operator, params)</a>
  </div>
  
    <div class="summary-synopsis"><p>Queries a table using matching criteria. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to do a specialized query this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#first/1">first(cmd)</a>
  </div>
  
    <div class="summary-synopsis"><p>Executes a query and returns the first matching record</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#limit/2">limit(cmd, length)</a>
  </div>
  
    <div class="summary-synopsis"><p>Alias for Query limit</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#offset/2">offset(cmd, length)</a>
  </div>
  
    <div class="summary-synopsis"><p>Alias for Query offset</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#remove/1">remove(cmd)</a>
  </div>
  
    <div class="summary-synopsis"><p>An alias for <a href="#delete/1"><code class="inline">delete/1</code></a>, removes a document based on the filter setup</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#remove/2">remove(cmd, id)</a>
  </div>
  
    <div class="summary-synopsis"><p>An alias for <a href="#delete/2"><code class="inline">delete/2</code></a>, removes a document with the specified ID</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#save/3">save(cmd, doc, search_params \\ [])</a>
  </div>
  
    <div class="summary-synopsis"><p>Saves a given document to the database. If an <code class="inline">id</code> is present, a full UPDATE will be performed (partial updates are not possible
with JSONB), otherwise an INSERT will happen. If you specify search criteria the <code class="inline">tsvector</code> search field will be updated for you</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#search/2">search(cmd, term)</a>
  </div>
  
    <div class="summary-synopsis"><p>Performs a Full Text query using a full table scan. Not a good choice for larger tables. If possible,
specify your search columns on <a href="#save/3"><code class="inline">save/3</code></a> and use <a href="#search/2"><code class="inline">search/2</code></a></p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#select_command/1">select_command(cmd)</a>
  </div>
  
    <div class="summary-synopsis"><p>Creates a SELECT command based on the assembled pipeline</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#sort/3">sort(cmd, cols, direction \\ :asc)</a>
  </div>
  
    <div class="summary-synopsis"><p>Sorts the query based on the supplied criteria</p>
</div>
  
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#to_list/1">to_list(cmd)</a>
  </div>
  
    <div class="summary-synopsis"><p>Executes a query returning a list of items</p>
</div>
  
</div>

  </div>


          

          

        </section>
      

      

      
        <section id="functions" class="details-list">
          <h1 class="section-heading">
            <a class="hover-link" href="#functions">
              <i class="icon-link"></i>
            </a>
            Functions
          </h1>
          <div class="detail" id="all/1">
  <div class="detail-header">
    <a href="#all/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">all(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L325" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    
  </section>
</div>
<div class="detail" id="contains/2">
  <div class="detail-header">
    <a href="#contains/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">contains(cmd, criteria)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L78" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>This is analagous to <code class="inline">filter</code> with the Query module, however this method is highly optimized for JSONB as it uses the <code class="inline">@</code> (contains)
operator. This flexes the GIN index created for your table (see above).</p>
<p>criteria:   -     A list of elements to look for. This list must be complete, partial matches won’t work.</p>
<p>Example:</p>
<pre><code class="elixir">db(:user_docs)
  |&gt; contains(email: &quot;test@test.com&quot;)
  |&gt; first</code></pre>

  </section>
</div>
<div class="detail" id="db/1">
  <div class="detail-header">
    <a href="#db/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">db(table)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L45" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Specifies the table or view you want to query and is an alias for the <a href="#db/1"><code class="inline">db/1</code></a> function using
a string as a table name. This is useful for specifying a table within a schema.</p>
<p>“table”  -   the name of the table you want to query, such as <code class="inline">membership.user_docs</code></p>
<p>Example</p>
<pre><code class="elixir">result = with(&quot;membership.user_docs&quot;)
  |&gt; to_list</code></pre>

  </section>
</div>
<div class="detail" id="delete/1">
  <div class="detail-header">
    <a href="#delete/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">delete(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L250" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Deletes a document based on the filter (if any)</p>

  </section>
</div>
<div class="detail" id="delete/2">
  <div class="detail-header">
    <a href="#delete/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">delete(cmd, id)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L237" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Deletes a document with the given id</p>

  </section>
</div>
<div class="detail" id="execute/2">
  <div class="detail-header">
    <a href="#execute/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">execute(cmd, opts \\ nil)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L334" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Executes a query returning a list of items</p>

  </section>
</div>
<div class="detail" id="exists/3">
  <div class="detail-header">
    <a href="#exists/3" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">exists(cmd, field, params)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L139" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Queries a table using the existence operator. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to query embedded arrays this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
<p>Example:</p>
<pre><code class="elixir">return = db(:user_docs)
  |&gt; exists(:pets, &quot;skippy&quot;) # :pets is an array
  |&gt; to_list</code></pre>

  </section>
</div>
<div class="detail" id="filter/3">
  <div class="detail-header">
    <a href="#filter/3" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">filter(cmd, criteria, params \\ [])</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L99" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Queries a table using matching string criteria. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to do a specialized query this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
<p>Example:</p>
<pre><code class="elixir">return = db(:user_docs)
  |&gt; filter(&quot;body -&gt; &#39;email&#39; = $1&quot;, res.email)
  |&gt; first</code></pre>

  </section>
</div>
<div class="detail" id="filter/4">
  <div class="detail-header">
    <a href="#filter/4" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">filter(cmd, field, operator, params)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L119" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Queries a table using matching criteria. Not a good query to run on a large table as it needs to do a full scan in order to match,
and can’t use the built-in index, however if you need to do a specialized query this is a good choice. If possible, use <a href="#contains/2"><code class="inline">contains/2</code></a></p>
<p>Example:</p>
<pre><code class="elixir">return = db(:user_docs)
  |&gt; filter(:id, &quot;&gt;&quot;, 100)
  |&gt; to_list</code></pre>

  </section>
</div>
<div class="detail" id="first/1">
  <div class="detail-header">
    <a href="#first/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">first(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L267" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Executes a query and returns the first matching record</p>
<p>Example:</p>
<pre><code class="elixir">return = db(:user_docs)
  |&gt; exists(:pets, &quot;skippy&quot;) # :pets is an array
  |&gt; sort(:city)
  |&gt; first</code></pre>

  </section>
</div>
<div class="detail" id="limit/2">
  <div class="detail-header">
    <a href="#limit/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">limit(cmd, length)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L165" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Alias for Query limit</p>

  </section>
</div>
<div class="detail" id="offset/2">
  <div class="detail-header">
    <a href="#offset/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">offset(cmd, length)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L169" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Alias for Query offset</p>

  </section>
</div>
<div class="detail" id="remove/1">
  <div class="detail-header">
    <a href="#remove/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">remove(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L245" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>An alias for <a href="#delete/1"><code class="inline">delete/1</code></a>, removes a document based on the filter setup.</p>

  </section>
</div>
<div class="detail" id="remove/2">
  <div class="detail-header">
    <a href="#remove/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">remove(cmd, id)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L232" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>An alias for <a href="#delete/2"><code class="inline">delete/2</code></a>, removes a document with the specified ID.</p>

  </section>
</div>
<div class="detail" id="save/3">
  <div class="detail-header">
    <a href="#save/3" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">save(cmd, doc, search_params \\ [])</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L207" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Saves a given document to the database. If an <code class="inline">id</code> is present, a full UPDATE will be performed (partial updates are not possible
with JSONB), otherwise an INSERT will happen. If you specify search criteria the <code class="inline">tsvector</code> search field will be updated for you.</p>
<p>Example:</p>
<pre><code class="elixir">product = %{sku: &quot;TEST_1&quot;, name: &quot;Test Product&quot;, description: &quot;Just a test&quot;}
return = db(:products)
  |&gt; save(product, [:name, :description]) #name and description fields will be indexed</code></pre>

  </section>
</div>
<div class="detail" id="search/2">
  <div class="detail-header">
    <a href="#search/2" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">search(cmd, term)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L284" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Performs a Full Text query using a full table scan. Not a good choice for larger tables. If possible,
specify your search columns on <a href="#save/3"><code class="inline">save/3</code></a> and use <a href="#search/2"><code class="inline">search/2</code></a>.</p>
<p>Example:</p>
<pre><code class="elixir">users = db(:user_docs)
  |&gt; search(for: &quot;test.com&quot;, in: [:email])</code></pre>

  </section>
</div>
<div class="detail" id="select_command/1">
  <div class="detail-header">
    <a href="#select_command/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">select_command(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L150" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Creates a SELECT command based on the assembled pipeline.</p>

  </section>
</div>
<div class="detail" id="sort/3">
  <div class="detail-header">
    <a href="#sort/3" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">sort(cmd, cols, direction \\ :asc)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L186" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Sorts the query based on the supplied criteria.</p>
<p>Example:</p>
<pre><code class="elixir">return = db(:user_docs)
  |&gt; exists(:pets, &quot;skippy&quot;) # :pets is an array
  |&gt; sort(:city)
  |&gt; to_list</code></pre>

  </section>
</div>
<div class="detail" id="to_list/1">
  <div class="detail-header">
    <a href="#to_list/1" class="detail-link" title="Link to this function">
      <i class="icon-link"></i>
    </a>
    <span class="signature">to_list(cmd)</span>
      
      <a href="https://github.com/robconery/moebius/blob/v1.0.0/lib/moebius/document_query.ex#L323" class="view-source" rel="help" title="View Source">
       <i class="icon-code"></i>
     </a>
    
  </div>
  
  <section class="docstring">
    <p>Executes a query returning a list of items</p>

  </section>
</div>

        </section>
      

      

      
        <footer class="footer">
      <p>
        <span class="line">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" rel="help" target="_blank">ExDoc</a> (v0.10.0),
        </span>
        <span class="line">
          designed by
          <a href="https://twitter.com/dignifiedquire" target="_blank" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
      </p>
    </footer>
  </div>
</section>
</div>
    <script src="dist/app.js"></script>
  </body>
</html>

